{% if page.toc != false %}
<!-- Auto-generated Table of Contents -->
{% assign headings = content | split: '<h2' %}
{% assign toc_items = "" | split: "" %}

{% for heading in headings offset: 1 %}
  {% assign heading_parts = heading | split: '</h2>' %}
  {% assign heading_content = heading_parts[0] | split: '>' | last | strip_html | strip %}
  {% assign toc_items = toc_items | push: heading_content %}
{% endfor %}

{% if toc_items.size > 0 %}
<nav class="table-of-contents" aria-labelledby="toc-heading">
  <h2 id="toc-heading" class="toc-title">Table of Contents</h2>
  <ol class="toc-list">
    {% for heading in headings offset: 1 %}
      {% assign heading_parts = heading | split: '</h2>' %}
      {% assign heading_content = heading_parts[0] | split: '>' | last | strip_html | strip %}
      {% assign heading_id = heading_content | slugify %}
      <li>
        <a href="#{{ heading_id }}" class="toc-link">{{ heading_content }}</a>
      </li>
    {% endfor %}
  </ol>
</nav>

<!-- Inject IDs into actual headings for anchor links using same slugify logic -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const headings = document.querySelectorAll('.guide-content h2');
    const toc = {{ toc_items | jsonify }};

    headings.forEach(function(heading, index) {
      if (!heading.id && toc[index]) {
        // Use same slugify logic as Jekyll: lowercase, replace non-alphanumeric with dashes
        const id = toc[index]
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-+|-+$/g, '');
        heading.id = id;
      }
    });

    // Smooth scroll to anchors
    document.querySelectorAll('.toc-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // Update URL without jumping
          history.pushState(null, null, '#' + targetId);
        }
      });
    });
  });
</script>
{% endif %}
{% endif %}
