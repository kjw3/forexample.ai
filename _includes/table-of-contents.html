{% if page.toc != false %}
<!-- Auto-generated Table of Contents -->
{% assign headings = content | split: '<h2' %}
{% assign toc_items = "" | split: "" %}

{% for heading in headings offset: 1 %}
  {% assign heading_parts = heading | split: '</h2>' %}
  {% assign heading_content = heading_parts[0] | split: '>' | last | strip_html | strip %}
  {% assign heading_id = heading_content | slugify %}
  {% assign toc_items = toc_items | push: heading_content %}
{% endfor %}

{% if toc_items.size > 0 %}
<nav class="table-of-contents" aria-labelledby="toc-heading" id="toc-nav">
  <div class="toc-header">
    <h2 id="toc-heading" class="toc-title">Table of Contents</h2>
    <button class="toc-toggle" aria-label="Toggle table of contents" aria-expanded="true">
      <svg class="toc-toggle-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
        <path class="icon-collapse" d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <ol class="toc-list" id="toc-list">
    {% for heading in headings offset: 1 %}
      {% assign heading_parts = heading | split: '</h2>' %}
      {% assign heading_content = heading_parts[0] | split: '>' | last | strip_html | strip %}
      {% assign heading_id = heading_content | slugify %}
      <li>
        <a href="#{{ heading_id }}" class="toc-link" data-target="{{ heading_id }}">{{ heading_content }}</a>
      </li>
    {% endfor %}
  </ol>
</nav>

<!-- Inject IDs into actual headings and setup scroll behavior -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get all H2 headings in guide content
    const headings = document.querySelectorAll('.guide-content h2');

    // Assign IDs to headings using EXACT Jekyll slugify logic
    headings.forEach(function(heading) {
      if (!heading.id) {
        const text = heading.textContent.trim();
        // Match Jekyll's slugify EXACTLY: replace all non-alphanumeric with single dash
        const id = text
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')  // Replace sequences of non-alphanumeric with single dash
          .replace(/^-+|-+$/g, '');      // Remove leading/trailing dashes
        heading.id = id;
        console.log('Assigned ID:', id, 'to heading:', text);
      }
    });

    // Setup smooth scroll with proper offset
    document.querySelectorAll('.toc-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);

        console.log('Clicked link for:', targetId);
        console.log('Found element:', targetElement);

        if (targetElement) {
          // Offset for fixed header - desktop: 100px, mobile: 80px
          const isMobile = window.innerWidth < 768;
          const offset = isMobile ? 80 : 100;
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });

          // Update URL
          history.pushState(null, null, '#' + targetId);
        } else {
          console.error('Element not found for ID:', targetId);
        }
      });
    });

    // Collapse/Expand functionality
    const tocToggle = document.querySelector('.toc-toggle');
    const tocList = document.getElementById('toc-list');
    const tocNav = document.getElementById('toc-nav');

    // Load saved state
    const tocCollapsed = localStorage.getItem('tocCollapsed') === 'true';
    if (tocCollapsed) {
      tocNav.classList.add('collapsed');
      tocToggle.setAttribute('aria-expanded', 'false');
    }

    tocToggle.addEventListener('click', function() {
      const isCollapsed = tocNav.classList.toggle('collapsed');
      tocToggle.setAttribute('aria-expanded', !isCollapsed);
      localStorage.setItem('tocCollapsed', isCollapsed);
    });
  });
</script>
{% endif %}
{% endif %}
