{% if page.toc != false %}
<!-- Auto-generated Table of Contents -->
{% assign headings = content | split: '<h2' %}
{% assign toc_items = "" | split: "" %}

{% for heading in headings offset: 1 %}
  {% assign heading_parts = heading | split: '</h2>' %}
  {% assign heading_content = heading_parts[0] | split: '>' | last | strip_html | strip %}
  {% assign heading_id = heading_content | slugify %}
  {% assign toc_items = toc_items | push: heading_content %}
{% endfor %}

{% if toc_items.size > 0 %}
<nav class="table-of-contents" aria-labelledby="toc-heading">
  <h2 id="toc-heading" class="toc-title">Table of Contents</h2>
  <ol class="toc-list">
    {% for heading in headings offset: 1 %}
      {% assign heading_parts = heading | split: '</h2>' %}
      {% assign heading_content = heading_parts[0] | split: '>' | last | strip_html | strip %}
      {% assign heading_id = heading_content | slugify %}
      <li>
        <a href="#{{ heading_id }}" class="toc-link" data-target="{{ heading_id }}">{{ heading_content }}</a>
      </li>
    {% endfor %}
  </ol>
</nav>

<!-- Inject IDs into actual headings and setup scroll behavior -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get all H2 headings in guide content
    const headings = document.querySelectorAll('.guide-content h2');

    // Assign IDs to headings using Jekyll's slugify logic
    headings.forEach(function(heading) {
      if (!heading.id) {
        const text = heading.textContent.trim();
        // Match Jekyll's slugify: lowercase, remove non-alphanumeric except spaces/dashes, replace spaces with dashes
        const id = text
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-+|-+$/g, '');
        heading.id = id;
        console.log('Assigned ID:', id, 'to heading:', text);
      }
    });

    // Setup smooth scroll with proper offset
    document.querySelectorAll('.toc-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('data-target');
        const targetElement = document.getElementById(targetId);

        console.log('Clicked link for:', targetId);
        console.log('Found element:', targetElement);

        if (targetElement) {
          // Offset for fixed header - desktop: 100px, mobile: 80px
          const isMobile = window.innerWidth < 768;
          const offset = isMobile ? 80 : 100;
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });

          // Update URL
          history.pushState(null, null, '#' + targetId);
        } else {
          console.error('Element not found for ID:', targetId);
        }
      });
    });
  });
</script>
{% endif %}
{% endif %}
