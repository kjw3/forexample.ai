{% if page.toc != false %}
<!-- Auto-generated Table of Contents -->
{% assign headings = content | split: '<h2' %}

{% if headings.size > 1 %}
<nav class="table-of-contents" aria-labelledby="toc-heading" id="toc-nav">
  <div class="toc-header">
    <h2 id="toc-heading" class="toc-title">
      <svg class="toc-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M3 4h14M3 10h14M3 16h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span class="toc-title-text">Contents</span>
    </h2>
    <button class="toc-toggle" aria-label="Toggle table of contents" aria-expanded="true" title="Collapse sidebar">
      <svg class="toc-toggle-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M8 5l5 5-5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <ol class="toc-list" id="toc-list">
    {% for heading in headings offset: 1 %}
      {% assign heading_parts = heading | split: '</h2>' %}
      {% assign heading_full = heading_parts[0] %}
      {% assign id_match = heading_full | split: 'id="' %}
      {% if id_match.size > 1 %}
        {% assign heading_id = id_match[1] | split: '"' | first %}
        {% assign heading_content = heading_full | split: '>' | last | strip_html | strip %}
        <li>
          <a href="#{{ heading_id }}" class="toc-link">{{ heading_content }}</a>
        </li>
      {% endif %}
    {% endfor %}
  </ol>
</nav>

<!-- Setup scroll behavior and collapse functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Setup smooth scroll with proper offset for TOC links
    document.querySelectorAll('.toc-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          // Large offset to ensure heading is clearly visible
          const offset = window.innerWidth >= 1024 ? 120 : 100;
          const elementPosition = targetElement.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - offset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });

          // Update URL
          history.pushState(null, null, '#' + targetId);
        }
      });
    });

    // Collapse/Expand functionality
    const tocToggle = document.querySelector('.toc-toggle');
    const tocNav = document.getElementById('toc-nav');
    const guideArticle = document.querySelector('.guide');

    if (tocToggle && tocNav) {
      // Load saved state
      const tocCollapsed = localStorage.getItem('tocCollapsed') === 'true';
      if (tocCollapsed) {
        tocNav.classList.add('collapsed');
        tocToggle.setAttribute('aria-expanded', 'false');
        tocToggle.setAttribute('title', 'Expand sidebar');
        if (guideArticle) {
          guideArticle.classList.add('toc-collapsed');
        }
      }

      tocToggle.addEventListener('click', function() {
        const isCollapsed = tocNav.classList.toggle('collapsed');
        tocToggle.setAttribute('aria-expanded', !isCollapsed);
        tocToggle.setAttribute('title', isCollapsed ? 'Expand sidebar' : 'Collapse sidebar');
        localStorage.setItem('tocCollapsed', isCollapsed);

        // Toggle class on guide article for layout adjustments
        if (guideArticle) {
          guideArticle.classList.toggle('toc-collapsed', isCollapsed);
        }
      });
    }
  });
</script>
{% endif %}
{% endif %}
